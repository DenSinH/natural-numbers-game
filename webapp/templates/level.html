<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>{{ world["name"] }}: {{ level["name"]|replace("`", '"') }}</title>
        <link rel="stylesheet" type="text/css" href="/static/level.css">
        <link rel="stylesheet" type="text/css" href="/static/base.css">
        <script src="/static/packages/jquery/jquery-3.6.3.min.js"></script>
        <script src="/static/packages/codemirror/codemirror-6.65.7.min.js"></script>
        <script src="/static/packages/codemirror/coq.js"></script>
        <link rel="stylesheet" type="text/css" href="/static/packages/codemirror/codemirror-6.65.7.min.css">
        <style>
            .CodeMirror:not(.CodeMirror-readonly) {
                height: auto;
                border: 1px solid black;
            }
        </style>
        <script>
            var socket;
            const socketReconnectInterval = 2000; // ms

            function initSocket() {
                socket = new WebSocket("{{ WEBSOCKET_SCHEME }}://{{ host }}{{ url_for('compile', _world=_world, _level=_level) }}");

                socket.onclose = function(event) {
                    // attempt reconnect on close (also happens on error)
                    setTimeout(() => initSocket(), socketReconnectInterval);
                };

                socket.addEventListener("open", (event) => {
                    console.log("Connected!");
                    if (editor.getValue()) {
                        recompile();
                    }
                });

                socket.addEventListener("message", (event) => {
                    let data = JSON.parse(event.data);
                    if (data.goal) {
                        $("#goals").html(`<pre>${data.goal}</pre>`);
                    }
                    if (data.completed && !completed) {
                        completed = data.completed;
                        storeState();
                        makeCompleted();
                    }
                });
            }

            var completed = false;
            var typingTimer;
            const doneTypingInterval = 250; // ms
            var editor;
            
            function getLocalStorageValue(key, def) {
                let global_values = JSON.parse(localStorage.getItem(key) || "{}");
                return global_values["{{ _world }}.{{ _level }}"] || def;
            }

            function setLocalStorageValue(key, val) {
                let global_values = JSON.parse(localStorage.getItem(key) || "{}");
                global_values["{{ _world }}.{{ _level }}"] = val;
                localStorage.setItem(key, JSON.stringify(global_values));
            }
            
            function loadState() {
                completed       = getLocalStorageValue("completed", false);
                if (completed) {
                    makeCompleted();
                }
                let editor_text = getLocalStorageValue("editor_text", null);
                if (editor_text !== null) {
                    editor.setValue(editor_text);
                    editor.setCursor({line: 999, ch: 999});
                }
            }

            function storeState() {
                setLocalStorageValue("completed", completed);
                setLocalStorageValue("editor_text", editor.getValue());
            }

            function makeUnCompleted() {
                $("#navigation-padding").css("background-color", "");
            }

            function makeCompleted() {
                $("#navigation-padding").css("background-color", "darkseagreen");
            }

            function reset() {
                editor.setValue("");
                completed = false;
                makeUnCompleted();
                storeState();
            }

            function recompile() {
                storeState();
                clearTimeout(typingTimer);

                // renew timer
                typingTimer = setTimeout(() => {
                    // get text up to cursor
                    let text = "";
                    let line = editor.doc.getCursor().line;
                    let char = editor.doc.getCursor().ch;
                    for (let i = 0; i < line; i++) {
                        text += editor.doc.getLine(i) + "\n";
                    }
                    text += editor.doc.getLine(line).substr(0, char);
                    socket.send(text);
                }, doneTypingInterval);
            };

            $(window).on("load", function() {
                $(".tactic .header").on("click", function() {
                    $(this).parent().find(".tactic-body").first().toggleClass("hidden");
                })
            });
        </script>
    </head>
    <body>
        <div class="navigation">
            <div>
                <div class="navbutton" onclick="location.href=`{{ url_for('index') }}`">Main Menu</div>
                {% if prev_level %}
                <div class="navbutton" onclick="location.href=`{{ url_for('level', **prev_level) }}`">Previous Level</div>
                {% else %}
                <div class="navbutton inactive">Previous Level</div>
                {% endif %}
            </div>
            <div id="navigation-padding"><!-- Padding between buttons --></div>
            <div>
                <div class="navbutton" onclick="reset()">Reset</div>
                {% if next_level %}
                <div class="navbutton" onclick="location.href=`{{ url_for('level', **next_level) }}`">Next Level</div>
                {% else %}
                <div class="navbutton inactive">Next Level</div>
                {% endif %}
            </div>
        </div>
        <div class="column-container">
            <div class="column tactics">
                {%- if tactics -%}
                <div class="tactic">
                    <div class="header">
                        <h3>Tactics</h3>
                    </div>
                    <div class="tactic-body hidden">
                        {%- for tactic in tactics -%}
                        <div class="tactic">
                            <div class="header">
                                <h3><code>{{ tactic["name"] }}</code></h3>
                            </div>
                            <div class="tactic-body hidden">
                                <h5>Description</h5>
                                {{ tactic["description"]|join("\n")|format_code_in_text|format_paragraphs_in_text|safe }}
                                {%- if tactic["example"] -%}
                                <h5>Example</h5>
                                <pre class="example">{{ tactic["example"]|join("\n") }}</pre>
                                {%- endif -%}
                            </div>
                        </div>
                        {%- endfor -%}
                    </div>
                </div>
                {%- endif -%}
                
                {%- if theorems -%}
                <div class="tactic">
                    <div class="header">
                        <h3>Theorems</h3>
                    </div>
                    <div class="tactic-body hidden">
                        {%- for world in theorems -%}
                        <div class="tactic">
                            <div class="header">
                                <h3><code>{{ WORLDS[world["world"]]["name"] }}</code></h3>
                            </div>
                            <div class="tactic-body hidden">
                                {%- for theorem in world["theorems"] -%}
                                <div class="theorem">
                                    <pre class="coq-code">{{ theorem["statement"] }}</pre>
                                </div>
                                {%- endfor -%}
                            </div>
                        </div>
                        {%- endfor -%}
                    </div>
                </div>
                {%- endif -%}
            </div>
            <div class="column main">
                <h1>{{ world["name"]|format_code_in_text|safe }}</h1>
                <h3>Level {{ level["level"] }}: {{ level["name"]|format_code_in_text|safe }}</h3>

                {{ level["prologue"]|format_paragraphs_in_text|format_code_in_text|safe }}
                
                <div class="lemma"><pre class="coq-code">{{ level["lemma"] }}</pre></div>
                <code>Proof.</code>
                <div class="editor">
                    <textarea id="editor"></textarea>
                </div>    
                <code>Qed.</code>

                {{ level["epilogue"]|format_paragraphs_in_text|format_code_in_text|safe }}
            </div>
            <div class="column compilers">
                <div class="compiler">
                    <div class="header">
                        <h3>Goals</h3>
                    </div>
                    <div id="goals"><pre>Websocket is connecting</pre>
                        <pre>to language server...</pre></div>
                </div>

                <div class="messages">
                    <div class="header">
                        <h3>Messages</h3>
                    </div>
                </div>
            </div>
        </div>
    </body>

    <footer>
        <script>
            // all the CodeMirror stuff after the html since we need the elements
            // to all be present
            editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
                mode: "text/x-coq",
                indentUnit: 2,
                lineNumbers: true,
                viewportMargin: Infinity,
            });
            editor.setValue("");

            // we need the editor to be loaded before we initalize the socket
            initSocket();
            loadState();

            editor.on("keydown", function(e) { clearTimeout(typingTimer); });
            editor.on("keyup", recompile);
            editor.on("mousedown", recompile);
        </script>
    </footer>
</html>
